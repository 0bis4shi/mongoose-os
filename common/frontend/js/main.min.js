"use strict";var App,h=preact.h,createClass=function(t){var e=function(){preact.Component.apply(this,arguments),t.init&&t.init.call(this,this.props)},s=e.prototype=Object.create(preact.Component.prototype);for(var a in t)s[a]=t[a];return s.constructor=e},login=function(t){t&&preactRouter.route("")},logout=function(t){document.cookie="access_token=;expires=Thu, 01 Jan 1970 00:00:00 GMT",preactRouter.route("login")},errorHandler=function(t){t.response&&401==t.response.status?logout(t):alert((((t.response||{}).data||{}).error||{}).message||t.message||t)},copyToClipboard=function(t){var e=document.createElement("input");e.style="position: absolute; left: -1000px; top: -1000px",e.value=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)},mkClipboardLink=function(e){return h("a",{href:"#",onClick:function(t){t.preventDefault(),copyToClipboard(e)}},"click to copy to clipboard")},map=function(t,e){for(var s=[],a=0;a<t.length;a++)s.push(e(t[a],a,t));return s},mkicon=function(t){return h("i",{class:"mr-2 fa fa-fw "+t})},mkinput=function(e,s,t,a){return h("input",{type:t?"password":"text",placeholder:a||"",onInput:function(t){e.state[s]=t.target.value,e.setState(e.state)},class:"form-control form-control-sm",value:e.state[s]})},SpinButton=createClass({init:function(){this.state={spin:!1}},render:function(t,e){var s=this;return h("button",{class:"btn btn-sm "+(t.class||""),disabled:t.disabled||e.spin,ref:t.ref,onClick:function(){s.setState({spin:!0}),t.onClick().catch(function(t){alert(t)}).then(function(){s.setState({spin:!1})})}},h("i",{class:"mr-2 fa fa-fw "+(e.spin?"fa-refresh":t.icon||"fa-save")+(e.spin?" fa-spin":"")}),t.title||"submit")}}),Header=createClass({init:function(){this.state={expanded:!1}},render:function(o){var i=this,t=window.title,e=h("img",{src:"images/logo.png",width:32,class:"mr-2"}),s=function(t,e,s,a){var n=o.url==e?" active":"";return h(preactRouter.Router.Link,{class:"nav-item nav-link "+n,href:e,onClick:function(){i.setState({expanded:!1})}},s,mkicon(t))},a=(App.state.user||{}).avatar_url||"",n=(App.state.user||{}).name||"",r=(App.state.user||{}).admin||!1,c=location.href.replace("console.","").replace(/#.*/,"");return h("nav",{class:"navbar navbar-expand-md navbar-dark bg-dark"},h("a",{class:"navbar-brand",href:c},e,t),h("button",{class:"navbar-toggler",type:"button",onClick:function(){i.setState({expanded:!i.state.expanded})}},h("span",{class:"navbar-toggler-icon"})),h("div",{class:"navbar-collapse "+(i.state.expanded?"":"collapse")},h("ul",{class:"navbar-nav mr-auto"},s("fa-wifi d-none","/","Devices"),s("fa-gears d-none","/settings","Settings"),s("fa-wifi d-none","/profile","Profile"),r?s("fa-wifi d-none","/admin","Admin"):"")),h("form",{class:"form-inline"},h("span",{class:"text-light px-3"},n),h("img",{class:"rounded-circle nav-item",width:26,src:a}),h("a",{href:"javascript:logout()",class:"text-white"},mkicon("fa-sign-out"))))}}),Login=createClass({init:function(t){var e=location.hash.split("?")[1];this.state={token:e}},componentDidMount:function(){login(this.state.token)},render:function(t,e){var s=this,a="https://github.com/login/oauth/authorize?scope=user:email&client_id="+githubOAuthClientID,n="https://accounts.google.com/o/oauth2/v2/auth?scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.email&access_type=offline&include_granted_scopes=true&state=state_parameter_passthrough_value&redirect_uri="+googleOAuthRedirectURI+"&response_type=code&client_id="+googleOAuthClientID;return h("div",{class:"justify-content-center align-items-center login h-100 d-flex"},h("form",{class:"form p-5 bg-light rounded",submit:function(t){t.preventDefault(),login(s.state.token)}},h("h4",{class:"text-center mb-4"},window.title+" login"),h("a",{class:"btn btn-block btn-dark",href:a},mkicon("fa-github"),"Login via GitHub"),h("a",{class:"btn btn-block btn-danger",href:n},mkicon("fa-google"),"Login via Google"),h("div",{class:"mt-3 small"},"Powered by ",h("a",{href:"https://mongoose-os.com"},"mongoose-os.com"))))}}),Key=function(t){return h("div",{class:"container-fluid"},h("div",{class:"row py-4"},h("div",{class:"col-12"},"Access Key: ",h("b",{class:"font-weight-bold"},App.state.user.api_key||""))))},Admin=createClass({init:function(){this.state={conns:{}},this.refresh(this)},refresh:function(e){return axios.get("/api/v1/proxy/list").then(function(t){e.setState({conns:t.data||{}})}).catch(errorHandler)},render:function(t,s){var a=window.location.protocol.replace("http","ws"),n=window.location.host,e=h("table",{class:"table xtable-responsive table-bordered w-100 my-3"},h("tr",{class:"thead-light"},h("th",{},"ConnectionID"),h("th",{},"SimID"),h("th",{},"Created"),h("th",{},"Link")),h("tbody",{},map(Object.keys(s.conns),function(t){var e=s.conns[t];return h("tr",{},h("td",{},t),h("td",{},(e.device||{}).id||"-"),h("td",{},moment(e.created_at).fromNow()),h("td",{},mkClipboardLink("mos --port "+a+"//"+n+"/api/v1/rpc/"+t+" ls")))})));return h("div",{class:"container-fluid"},e)}}),Profile=createClass({init:function(t){this.state={},this.refreshState(t)},refreshState:function(t){this.setState({company:t.user.company||"",address:t.user.address||"",phone:t.user.phone||"",email:t.user.email||"",full_name:t.user.full_name||""})},componentWillReceiveProps:function(t){this.refreshState(t)},render:function(t,e){var s=this;return h("div",{class:"container-fluid"},h("div",{class:"card-deck my-4"},h("div",{class:"card"},h("div",{class:"card-header"},"Account profile information"),h("div",{class:"card-body"},h("div",{class:"row form-group"},h("label",{class:"col-5 col-form-label text-right"},"Full Name:"),h("div",{class:"col-7"},mkinput(s,"full_name")),h("label",{class:"col-5 col-form-label text-right"},"Company:"),h("div",{class:"col-7"},mkinput(s,"company")),h("label",{class:"col-5 col-form-label text-right"},"Email:"),h("div",{class:"col-7"},mkinput(s,"email")),h("label",{class:"col-5 col-form-label text-right"},"Address:"),h("div",{class:"col-7"},mkinput(s,"address")),h("label",{class:"col-5 col-form-label text-right"},"Phone:"),h("div",{class:"col-7"},mkinput(s,"phone")),h("label",{class:"col-5 col-form-label text-right"},""),h("div",{class:"col-7"},h(SpinButton,{class:"btn-block btn-info",onClick:function(){return axios.post("/api/v1/user",{full_name:e.full_name,company:e.company,address:e.address,email:e.email,phone:e.phone}).then(function(t){App.setState({user:t.data||{}})}).catch(errorHandler)},title:"Save"}))))),h("div",{class:"card"},h("div",{class:"card-header"},"API access"),h("div",{class:"card-body"},mkClipboardLink(location.protocol+"//"+location.host+"/api/v1/user?access_token="+App.state.user.api_key)))))}}),Settings=createClass({defaults:{autoconf:"",aws_region:"",aws_key_id:"",aws_key:"",mqtt_server:"",mqtt_username:"",mqtt_password:"",bics_org_id:"",bics_username:"",bics_password:""},init:function(t){this.state=Object.assign({},this.defaults),this.refreshState(t)},refreshState:function(t){var e=this;axios.get("/api/v1/settings").then(function(t){e.setState(t.data||Object.assign({},e.defaults))}).catch(errorHandler),this.setState({})},componentWillReceiveProps:function(t){this.refreshState(t)},render:function(t,e){var s=this,a=h("div",{class:"row form-group mb-0 pb-0"},h("label",{class:"col-5 col-form-label text-right"},"Region:"),h("div",{class:"col-7"},mkinput(s,"aws_region",!1,"eu-west-1")),h("label",{class:"col-5 col-form-label text-right"},"KeyID:"),h("div",{class:"col-7"},mkinput(s,"aws_key_id",!0)),h("label",{class:"col-5 col-form-label text-right"},"Key:"),h("div",{class:"col-7"},mkinput(s,"aws_key",!0),h("label",{class:"col-5 col-form-label text-right"})),h("div",{class:"mx-3 w-100"},"See ",h("a",{href:"https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html"},"AWS credentials")," docs")),n=h("div",{class:"row form-group mb-0 pb-0"},h("label",{class:"col-5 col-form-label text-right"},"Server:"),h("div",{class:"col-7"},mkinput(s,"mqtt_server",!1,"my.backend.com:1883")),h("label",{class:"col-5 col-form-label text-right"},"Username:"),h("div",{class:"col-7"},mkinput(s,"mqtt_username")),h("label",{class:"col-5 col-form-label text-right"},"Password:"),h("div",{class:"col-7"},mkinput(s,"mqtt_password",!0))),o=h("div",{class:"row form-group mb-0 pb-0"},h("label",{class:"col-5 col-form-label text-right"},"OrgID:"),h("div",{class:"col-7"},mkinput(s,"bics_org_id")),h("label",{class:"col-5 col-form-label text-right"},"Username:"),h("div",{class:"col-7"},mkinput(s,"bics_username")),h("label",{class:"col-5 col-form-label text-right"},"Password:"),h("div",{class:"col-7"},mkinput(s,"bics_password",!0)));return h("div",{class:"container-fluid"},h("div",{class:"my-4 form-inline"},"Provision new devices on:",h("div",{class:"input-group-sm"},h("select",{class:"custom-select ml-3",onChange:function(t){e.autoconf=t.target.value,s.setState(e)},value:e.autoconf||""},h("option",{value:""},"none"),h("option",{value:"aws"},"AWS IoT"),h("option",{value:"mqtt"},"Generic MQTT")))),h("div",{class:"card-deck my-2"},h("div",{class:"card"},h("div",{class:"card-header"},"AWS IoT settings"),h("div",{class:"card-body"},a)),h("div",{class:"card"},h("div",{class:"card-header"},"BICS Sim for Things"),h("div",{class:"card-body"},o)),h("div",{class:"card"},h("div",{class:"card-header"},"Generic MQTT settings"),h("div",{class:"card-body"},n))),h("div",{class:"my-3 btn btn-sm btn-info",onClick:function(){return axios.post("/api/v1/settings",s.state).catch(errorHandler)}},mkicon("fa-save"),"Save Settings"))}}),Home=createClass({init:function(t){var e=this;this.state={devices:[]},this.wsEventHandler=function(){e.refresh()}},refresh:function(){var s=this;axios.get("/api/v1/devices").then(function(t){var e=t.data||[];e.sort(function(t,e){return t.id>e.id?1:-1}),s.setState({devices:e})}).catch(errorHandler)},componentDidMount:function(){this.refresh(),App.pubsub.subscribe("ws",this.wsEventHandler)},componentWillUnmount:function(){App.pubsub.unsubscribe("ws",this.wsEventHandler)},render:function(t,u){var p=this;return h("div",{class:"container-fluid"},h("div",{class:"row py-4"},h("div",{class:"col-12"},h("table",{class:"table table-responsive table-bordered w-100"},h("tr",{class:"thead-light text-nowrap"},h("th",{},"SIM ID"),h("th",{},"Status"),h("th",{},"Provisioned"),h("th",{},"Host MCU OTA"),h("th",{},"Host MCU Firmware Version"),h("th",{},"CLI command")),h("tbody",{class:"text-nowrap"},map(u.devices,function(s,t){var a,e,n,o,i=mkClipboardLink("mos --port "+location.protocol.replace("http","ws")+"//"+location.host+"/api/v1/rpc/"+s.connection_id+" ls"),r=h(SpinButton,{class:"my-0 btn-default",title:"choose firmware file...",icon:"fa-download",ref:function(t){a=t},onClick:function(){return e.click(),new Promise(function(t){n?n.then(function(t){t.data&&(s.host_sys_info=t.data.host_sys_info,p.setState(u))}).catch(errorHandler).then(function(){n=null,t()}):t()})}}),c=h("input",{type:"file",class:"d-none",onChange:function(t){if(t.target.files[0]){var e=new FormData;e.append("file",t.target.files[0]),e.append("id",s.id),t.target.value="",t.preventDefault(),n=axios.post("/api/v1/ota",e),a.base.click()}},ref:function(t){e=t}}),l=h("div",{class:"form-inline d-inline"},c,r),d=(((s.config||{}).device||{}).id||"-")+"@"+(((s.config||{}).mqtt||{}).server||"-");return"-@-"==d&&(d="-"),h("tr",{},h("td",{},s.id),h("td",{},s.connection_id?h("b",{class:"text-success"},"online"):"seen "+moment(s.updated_at).fromNow()),h("td",{},d),h("td",{},s.connection_id?l:"-"),h("td",{},(o=s.host_sys_info)?[o.app,o.arch,o.fw_version,o.fw_id].join("/"):"-"),h("td",{},s.connection_id?i:"-"))}))))))}}),Instance=createClass({init:function(t){var e,s;window.localStorage||(window.localStorage={}),this.state={token:(e="access_token",s=document.cookie.match("(^|;) ?"+e+"=([^;]*)(;|$)"),s?s[2]:""),url:"/",user:{}},(App=this).pubsub=util.pubsub(),util.websocket("api/v1/events").onmessage=function(t){console.log("ws ->",t),App.pubsub.publish("ws",t)}},componentDidMount:function(){this.state.token&&axios.get("/api/v1/user").then(function(t){return App.setState({user:t.data||{}}),axios.get("/api/v1/user/isadmin")}).then(function(t){App.state.user.admin=t.data||!1,App.setState(App.state)}).catch(errorHandler)},render:function(t,e){App.state.token||"#/login"==location.hash||preactRouter.route("login");var s=h(Header,{url:App.state.url});return h("div",{class:"page h-100"},h(preactRouter.Router,{history:History.createHashHistory(),onChange:function(t){App.setState({url:t.url})}},h("div",{default:!0},s,h(Home)),h("div",{path:"settings"},s,h(Settings,e)),h("div",{path:"profile"},s,h(Profile,e)),h("div",{path:"admin"},s,h(Admin,e)),h(Login,{path:"login"})))}});preact.render(h(Instance),document.body);
